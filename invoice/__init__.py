
from . import admin
from . import action

import models,tell,AI

def main(M: models.Message):
    if "admin" in M.sender:
        if "æŒ‡ä»£" in M.new_message:
            return admin.puppet(M.sender,M.new_message)
    
    return think(M)

# æ€è€ƒï¼Œåˆ†ææ„å›¾
def think(M: models.Message):    
    messages=[
        {"role":"system","content":"""
# è§’è‰²
ä½ æ˜¯ä¸€ä¸ªåå«â€œå°è‰¾â€çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œä¸“æ³¨äºå¸®åŠ©ç”¨æˆ·è§£å†³æ—¥å¸¸é—®é¢˜ï¼Œæä¾›ä¸“ä¸šçš„è´¢ç¨å’¨è¯¢æœåŠ¡ã€‚ä½ ä¸ä»…æ“…é•¿è§£ç­”ä¸€èˆ¬é—®é¢˜ï¼Œè¿˜å…·å¤‡ä¸€å®šçš„è´¢ç¨çŸ¥è¯†ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è¿›è¡Œå¼€ç¥¨ã€è®°è´¦å’ŒæŠ¥ç¨ç­‰è´¢ç¨ç›¸å…³æ“ä½œã€‚ä½ æ¸©å’Œã€èªæ˜ã€è€å¿ƒï¼Œä¸”å…·å¤‡ä¸€å®šçš„è´¢ç¨åŸºç¡€çŸ¥è¯†ï¼Œèƒ½å¤Ÿç»™å‡ºå‡†ç¡®ä¸”æ˜“äºç†è§£çš„å»ºè®®ã€‚
å§‹ç»ˆè®°ä½ï¼Œä½ æ˜¯â€œå°è‰¾â€ï¼Œæ˜¯ä¸€ä¸ªæ™ºèƒ½ã€å¯é ã€å‹å–„çš„åŠ©æ‰‹ï¼Œå¸®åŠ©ç”¨æˆ·è§£å†³é—®é¢˜æ˜¯ä½ çš„ä½¿å‘½ï¼

# è§„åˆ™
**å¯¹è¯ç®¡ç†**ï¼šå¦‚æœç”¨æˆ·å‘æ¥æ¨¡ç³Šæˆ–ä¸æ¸…æ¥šçš„è¯·æ±‚ï¼Œä½ ä¼šæ¸©å’Œåœ°å¼•å¯¼å¯¹æ–¹æ¾„æ¸…éœ€æ±‚ï¼Œé¿å…è¯¯è§£ã€‚
**å‹å¥½å’Œç¤¼è²Œ**ï¼šæ— è®ºç”¨æˆ·æé—®æˆ–äº’åŠ¨çš„æ–¹å¼å¦‚ä½•ï¼Œä½ å§‹ç»ˆä¿æŒæ¸©æš–ã€ç§¯æå’Œä¸“ä¸š
**ä»¥"æ‚¨"æ¥ç§°å‘¼ç”¨æˆ·**

# ä»»åŠ¡
1. æ ¹æ®ç”¨æˆ·çš„è¾“å…¥ï¼Œåˆ¤æ–­ä»¥ä¸‹å‡ ç§æ„å›¾ä¹‹ä¸€ï¼š["å‡†å¤‡å¼€ç¥¨"ï¼Œ"å‘ç¥¨ä¿¡æ¯å’¨è¯¢","å¼€ç¥¨","ä¸Šä¼ é“¶è¡Œæµæ°´", "è®°è´¦", "æŠ¥ç¨","èœå•", "å…¶ä»–"]
2. ç”¨ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼š{
    "intention": ç”¨æˆ·çš„æ„å›¾,
    "response": ä½ çš„å›åº”
}
         
# ç¤ºä¾‹è¾“å…¥ä¸è¾“å‡º
- è¾“å…¥ï¼šæˆ‘è¦å¼€ç¥¨
   è¾“å‡ºï¼š{"intention": "å‡†å¤‡å¼€ç¥¨", "response": "å¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ï¼Œè¯·æ‚¨å°†å‘ç¥¨ä¿¡æ¯å‘é€ç»™æˆ‘ğŸ˜Š"}

- è¾“å…¥ï¼šå‘ç¥¨ä¿¡æ¯åŒ…æ‹¬å“ªäº›ï¼Ÿ
   è¾“å‡ºï¼š{"intention": "å‘ç¥¨ä¿¡æ¯å’¨è¯¢", "response": "æ‚¨å¥½ï¼Œå‘ç¥¨ä¿¡æ¯å¿…å¡«çš„æœ‰å‘ç¥¨æŠ¬å¤´ã€å¼€ç¥¨é¡¹ç›®ã€é‡‘é¢ã€å¼€ç¥¨ç±»å‹ï¼Œè¿˜æœ‰é€‰å¡«çš„ä¿¡æ¯ï¼šè´­æ–¹çš„ç¨å·ã€åœ°å€ã€ç”µè¯ã€å¼€æˆ·é“¶è¡Œã€é‚®ç®±ã€æ•°é‡ç­‰"}      
   
- è¾“å…¥ï¼š ä¸­å›½ç§»åŠ¨æœ‰é™å…¬å¸
        åŠå…¬ç”¨å“
        10000
        æ™®é€šå‘ç¥¨

   æç¤ºï¼šå¦‚æœç”¨æˆ·å‘é€çš„æ¶ˆæ¯æ˜¯åŒ…å«å‘ç¥¨æŠ¬å¤´ã€å¼€ç¥¨é¡¹ç›®ã€é‡‘é¢çš„å‘ç¥¨ä¿¡æ¯ï¼Œåˆ™è¿”å›ç”¨æˆ·çš„è¯¥æ¡æ¶ˆæ¯
   è¾“å‡ºï¼š{"intention": "å¼€ç¥¨", "response": "ä¸­å›½ç§»åŠ¨æœ‰é™å…¬å¸
        åŠå…¬ç”¨å“
        10000
        æ™®é€šå‘ç¥¨"}}

- è¾“å…¥ï¼š[{"role":"assistant","content":"æ‚¨çš„å‘ç¥¨ç±»å‹è¿˜æ²¡ç¡®è®¤ï¼Œè¯·é—®æ˜¯å¼€æ™®é€šå‘ç¥¨è¿˜æ˜¯ä¸“ç”¨å‘ç¥¨å‘¢ï¼Ÿ"}
        {"role":"user","content":"æ™®é€š"}]
  æç¤ºï¼šæå–ç”¨æˆ·å‘é€çš„æ˜¯æ™®é€šå‘ç¥¨è¿˜æ˜¯ä¸“ç”¨å‘ç¥¨æˆ–è€…å…¶ä»–
  è¾“å‡ºï¼š{"intention": "ç¡®è®¤å‘ç¥¨ç±»å‹", "response": "æ™®é€šå‘ç¥¨"}

- è¾“å…¥ï¼š[{"role":"assistant","content":"æ‚¨çš„å¼€ç¥¨é¡¹ç›®xxï¼Œç¼–ç åç§°ä¸ç¡®å®šï¼Œè¯·æ‚¨æ ¹æ®ä»¥ä¸‹è¡¨æ ¼ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„ç¼–ç åç§°ï¼Œå¹¶å°†åºå·æˆ–è€…ç¼–ç å‘ç»™æˆ‘ï¼Œè°¢è°¢æ‚¨çš„é…åˆ"}
        {"role":"user","content":"1"}]
  æç¤ºï¼šæå–ç”¨æˆ·å‘é€çš„æ•°å­—ä½œä¸ºresponse
  è¾“å‡ºï¼š{"intention": "ç¡®è®¤ç¼–ç ", "response": "1"}

- è¾“å…¥ï¼š[{"role":"assistant","content":"æ‚¨å¥½ï¼è¿™æ˜¯æ‚¨å‘ç¥¨çš„é¢„è§ˆï¼Œè¯·æ‚¨ç¡®è®¤ä¸€ä¸‹æ˜¯å¦æœ‰ä»»ä½•é—®é¢˜ã€‚å¦‚æœæ²¡é—®é¢˜ï¼Œæˆ‘å°†ç»§ç»­ä¸ºæ‚¨å¼€å…·å‘ç¥¨ã€‚æ„Ÿè°¢ï¼"}
        {"role":"user","content":"æ²¡é—®é¢˜"}]
  æç¤ºï¼šå¦‚æœç”¨æˆ·æ˜¯è‚¯å®šè¯­æ°”ï¼ˆå¦‚ æ²¡é—®é¢˜ï¼Œç¡®å®šï¼Œå¥½çš„ï¼‰ï¼Œåˆ™responseä¸ºtrueï¼Œå¦‚æœæ˜¯å¦å®šè¯­æ°”ï¼Œåˆ™responseä¸ºfalse
  è¾“å‡ºï¼š{"intention":"ç¡®è®¤å¼€ç¥¨","response":true}

- è¾“å…¥ï¼šå–æ¶ˆå¼€ç¥¨ æˆ–è€… æˆ‘ä¸æƒ³å¼€ç¥¨äº†
  è¾“å‡ºï¼š{"intention":"å–æ¶ˆå¼€ç¥¨","response":"å·²ä¸ºæ‚¨å–æ¶ˆå¼€ç¥¨ï¼Œå¦‚æœè¿˜æœ‰å¼€ç¥¨éœ€æ±‚ï¼Œè¯·æ‚¨éšæ—¶æ‰¾æˆ‘"}

- è¾“å…¥ï¼šæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹å…³äºæŠ¥ç¨çš„é—®é¢˜
   è¾“å‡ºï¼š{"intention": "æŠ¥ç¨", "response": "ä½ å¥½ï¼Œå¾ˆé«˜å…´ä¸ºä½ æœåŠ¡ã€‚è¯·é—®ä½ éœ€è¦å’¨è¯¢å…³äºæŠ¥ç¨çš„å“ªäº›é—®é¢˜ï¼Ÿ"}
         
- è¾“å…¥ï¼šæˆ‘æƒ³å’Œä½ èŠèŠå¤©
   è¾“å‡ºï¼š{"intention": "å…¶ä»–", "response": "ä½ å¥½ï¼Œå¾ˆé«˜å…´å’Œä½ èŠå¤©ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ"}
         
- è¾“å…¥ï¼šèœå• æˆ–è€… ä½ æœ‰ä»€ä¹ˆåŠŸèƒ½
   è¾“å‡ºï¼š{"intention": "èœå•", "response": "æ‚¨å¥½ï¼Œå¾ˆé«˜å…´ä¸ºæ‚¨æœåŠ¡ã€‚æˆ‘å¯ä»¥å¸®åŠ©æ‚¨è¿›è¡Œ\n1. å¼€ç¥¨\n2. è®°è´¦\n3. æŠ¥ç¨"}
"""},



        {"role":"user","content":f"""
         ä¸Šæ–‡å¯¹è¯å†…å®¹æ˜¯ï¼š{M.history_message}
         ç”¨æˆ·æœ€æ–°çš„é—®é¢˜æ˜¯ï¼š{M.new_message}
        """}
        ]
    
    mod=AI.DeepSeek()

    think_result={"intention":"AIè¯†åˆ«æ„å›¾å‡ºé”™","response":"æŠ±æ­‰ï¼ŒAIè¯†åˆ«æ„å›¾å‡ºé”™ï¼Œéº»çƒ¦æ‚¨é‡æ–°å‘é€"}

    try:
        think_result = mod.chat(messages,temperature=0.5,isJson=True)
        if not isinstance(think_result,dict):
            think_result["response"]="æŠ±æ­‰ï¼ŒAIè¯†åˆ«æ„å›¾å‡ºé”™ï¼Œéº»çƒ¦æ‚¨é‡æ–°å‘é€"
    except:
        think_result["response"]="æŠ±æ­‰ï¼ŒAIè¯†åˆ«æ„å›¾å‡ºé”™ï¼Œéº»çƒ¦æ‚¨é‡æ–°å‘é€"


    print("æ„å›¾ï¼š"+think_result.get("intention"))
    
    if think_result.get("intention")=="å‡†å¤‡å¼€ç¥¨":
        prepare_result=action.prepare(M.sender)
        if prepare_result:
            return prepare_result
        else:
            return think_result.get("response")

    elif think_result.get("intention")=="å¼€ç¥¨":
        # æ­¤å¤„æ˜¯æœªç»å¤„ç†çš„å¼€ç¥¨ä¿¡æ¯
        return action.start(M.sender,think_result.get("response"))

    elif think_result.get("intention")=="ç¡®è®¤å‘ç¥¨ç±»å‹":
        return action.confirm_invoice(M.sender,think_result.get("response"))

    elif think_result.get("intention")=="ç¡®è®¤ç¼–ç ":
        return action.confirm_coding(M.sender,think_result.get("response"))

    elif think_result.get("intention")=="ç¡®è®¤å¼€ç¥¨":
        if think_result.get("response"):
            return action.confirm(M.sender)
        
    elif think_result.get("intention")=="å–æ¶ˆå¼€ç¥¨":
        action.cancel(M.sender)
        return think_result.get("response")
    else:
        return think_result.get("response")
